id: bd896e22-a0a7-4b4e-aa9f-46e28ddc6842
name: AuditD - User has been added, but the password has not been set
description: |
  'Identifies when a user is added but the password has not been set within a specified time range.
    To enable this rule, the following AuditD rules must be applied:
      -w /usr/sbin/useradd -p x -k user_mgmt_useradd
      -w /usr/sbin/adduser -p x -k user_mgmt_adduser
      -w /usr/bin/passwd -p x -k identity_passwd_exec'
severity: Medium
status: Available
requiredDataConnectors:
- connectorId: AuditDSyslog
  dataTypes:
  - Syslog
queryFrequency: 1h
queryPeriod: 1h
triggerOperator: gt
triggerThreshold: 0
tactics:
- Persistence
- DefenseEvasion
- CredentailAccess
relevantTechniques:
- T1136.001
- T1136.002
- T1078
query: |-
  let userAddKeys = dynamic(["user_mgmt_useradd", "user_mgmt_adduser"]);
  let passwordChangeKeys = dynamic(["identity_passwd_exec"]);
  // getting user addition events
  let auditEventIds = ASim_LinuxAuditdSyslog_V01(disabled=false)
      | where key in (userAddKeys)
      | project auditEventId;
  let auditEvents = ASim_LinuxAuditdSyslog_V01(disabled=false)
      | where auditEventId in (auditEventIds);
  // filtering user addition events and gathering usernames
  let UserAdditionEventsFiltered = auditEvents
      | where AuditdType == 'EXECVE' and (a0 == 'adduser' or a0 == 'useradd')
      | extend addedUser = tostring(split(allArgs, " ")[-1])
      | project
          CreatedAt = TimeGenerated,
          addedUser,
          Dvc,
          auditEventId,
          SyslogMessage;
  // getting passwd events
  let UserChangePasswdIds = ASim_LinuxAuditdSyslog_V01(disabled=false)
      | where key in (passwordChangeKeys)
      | project auditEventId;
  let UserChangePasswdEvents = ASim_LinuxAuditdSyslog_V01(disabled=false)
      | where auditEventId in (UserChangePasswdIds);
  // filtering passwd events and gathering usernames
  let UserChangePasswdEventsFiltered = UserChangePasswdEvents
      | where AuditdType == "EXECVE" and a0 in ('passwd')
      | extend modUser = tostring(split(allArgs, " ")[-1])
      | where modUser != 'passwd' or isnotempty(modUser)
      | project ModifiedAt=TimeGenerated, modUser, Dvc, auditEventId;
  // looking for users without changed password
  // Alert if 'ModifyAuditEventId' and 'ModifiedAt' is empty. They should be empty
  UserAdditionEventsFiltered
      | join kind=leftouter (UserChangePasswdEventsFiltered) on $left.addedUser == $right.modUser and $left.Dvc == $right.Dvc
      | where isnull(ModifiedAt)
      | project Dvc, 
          Username=addedUser, 
          CreatedAt, 
          CreateAuditEventId=auditEventId,
          ModifiedAt,
          ModifyAuditEventId=auditEventId
entityMappings:
- entityType: Host
  fieldMappings:
  - identifier: HostName
    columnName: Dvc
- entityType: Account
  fieldMappings:
  - identifier: Name
    columnName: Username
version: 1.0.0
kind: Scheduled
